# ======================================
# Networks
# ======================================
networks:
  g-task-network:
    driver: bridge
    name: g-task-network

# ======================================
# Volumes
# ======================================
volumes:
  mysql-data:
    name: g-task-mysql-data
  redis-data:
    name: g-task-redis-data
  app-logs:
    name: g-task-app-logs

# ======================================
# Services
# ======================================
services:
  traefik:
    image: traefik:3.6
    container_name: g-task-traefik
    restart: unless-stopped
    command:
      # API and Dashboard
      - "--api.insecure=true"
      - "--api.dashboard=true"

      # Providers
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=g-task-network"

      # Entrypoints
      - "--entrypoints.web.address=:80"

      # Access logs
      - "--accesslog=true"
      - "--log.level=INFO"
    ports:
      - "80:80"         # HTTP
      - "8080:8080"     # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - g-task-network
    labels:
      - "traefik.enable=true"
      # Dashboard
      - "traefik.http.routers.dashboard.rule=Host(`traefik.g-task.tojest.dev`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=web"

  mysql:
    image: mysql:8.0
    container_name: g-task-mysql
    restart: unless-stopped
    command: --default-authentication-plugin=mysql_native_password
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root_password}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-app_db}
      MYSQL_USER: ${MYSQL_USER:-app_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-app_password}
    volumes:
      - mysql-data:/var/lib/mysql
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - g-task-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-root_password}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    labels:
      - "traefik.enable=false"

  redis:
    image: redis:7-alpine
    container_name: g-task-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - g-task-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "traefik.enable=false"

  php-app:
    image: ${DOCKER_IMAGE:-ghcr.io/recruitment/php-containerization-poc:latest-production}
    container_name: g-task-app
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - ./docker/etc/environment:/etc/environment:ro
      - app-logs:/var/log/apache2
    environment:
      # These are also loaded from /etc/environment via entrypoint
      APP_ENV: production
      APP_NAME: "G-Task Application"
      APP_DEBUG: "false"
      MYSQL_HOST: mysql
      MYSQL_DATABASE: ${MYSQL_DATABASE:-app_db}
      MYSQL_USER: ${MYSQL_USER:-app_user}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-app_password}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    networks:
      - g-task-network
    labels:
      - "traefik.enable=true"
      # HTTP Router
      - "traefik.http.routers.g-task.rule=Host(`g-task.tojest.dev`)"
      - "traefik.http.routers.g-task.entrypoints=web"
      - "traefik.http.services.g-task.loadbalancer.server.port=80"
      # Health check
      - "traefik.http.services.g-task.loadbalancer.healthcheck.path=/"
      - "traefik.http.services.g-task.loadbalancer.healthcheck.interval=10s"

